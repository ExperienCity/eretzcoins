'use strict';

var appData = {	
	"imageBefore" : 
		[
			"https://lh3.googleusercontent.com/-nDpimsRs3S0/UbasjQVnOhI/AAAAAAAAOFM/tGGKu-TU7fo/20130611073318.png",
			"https://lh5.googleusercontent.com/-vEOe5bcUJ1w/UbarurFIjMI/AAAAAAAAOD8/3kwmbpxPDUM/20130611074507.png",
			"https://lh6.googleusercontent.com/-5DYEGTLFOHA/UbasF92kS9I/AAAAAAAAOEs/W6rr5B2Py-I/20130611074420.png",
			"https://lh3.googleusercontent.com/-Nd2g28oINp8/UbatGNKYLDI/AAAAAAAAOGk/dzd9bjr-qGs/20130611074000.png",
			"https://lh4.googleusercontent.com/-lhvDDmG5n3s/UbathbDElVI/AAAAAAAAOHk/qPOCeiNUcGA/20130611073428.png",
			"https://lh6.googleusercontent.com/-98FDU4pZYzw/UbasLgwt1sI/AAAAAAAAOFE/bICpe2VAWec/20130611073617.png",
			"https://lh5.googleusercontent.com/-hMSkRv2r8CA/Ubas4nz0_bI/AAAAAAAAOF8/XVH0Xdqkl7I/20130611073529.png",
			"https://lh6.googleusercontent.com/-ai-GHC7otgs/Uba7uQE-QCI/AAAAAAAAOIs/tK6mCC-KSqg/20130611073341.png",
			"https://lh5.googleusercontent.com/-N2Rz-kGSdcE/Uaxm_nxiF3I/AAAAAAAAN5Q/kG5lgsoxmww/1111.jpg",
			"https://lh6.googleusercontent.com/-ai-GHC7otgs/Uba7uQE-QCI/AAAAAAAAOIs/tK6mCC-KSqg/20130611073341.png",
			"https://lh3.googleusercontent.com/-nDpimsRs3S0/UbasjQVnOhI/AAAAAAAAOFM/tGGKu-TU7fo/20130611073318.png",
			"https://lh5.googleusercontent.com/-8tj6jvyh0Pk/Ubaxgmb8WcI/AAAAAAAAOIE/AJCQzKXDDyk/20130611075842.png",
			"https://lh3.googleusercontent.com/-hjptr78VUiI/UbaxhQXXxtI/AAAAAAAAOIM/kjNBEPbtgbE/20130611075952.png",
			"https://lh6.googleusercontent.com/-ai-GHC7otgs/Uba7uQE-QCI/AAAAAAAAOIs/tK6mCC-KSqg/20130611073341.png",
			"https://lh3.googleusercontent.com/-BSoAFJQSOjs/Ubar_r-e7jI/AAAAAAAAOEU/T5jtJHSvGSc/20130611073638.png",
			"https://lh4.googleusercontent.com/-ItbK2yg7C0U/UbaxtxvuaqI/AAAAAAAAOIc/Y4F2yyOOQ0g/20130611075936.png"			
		],
	"questions" : 
		[
			"אני הסמל הרשמי של העיר אתונה",
			"דמותי מוטבעת על שני מטבעות: חצי שקל וחמש לירות",
			"אני אחת החיות היחידות המופיעות על המטבעות המוסלמים ובמטבע אני מופיע עם שני ראשים",
			"אני בדרך כלל עוסק בחקלאות ומשמש לנשיאת משאות, אך כאן אני מסמל את העיר שנכבשה",
			"אני הוא אלכסנדר מוקדון, גדול מצביאי יון. על מנת להנציח את זכרי וגדולתי הוטבעתי על מטבע כשעל ראשי ראש של חיה אצילית . איזו חיה זו",
			"השתתפתי ברבים מקרבות היוונים ומספר שליטים הטביעו מטבע שמנציח את כוחי",
			"אני מופיע על מטבעות רבים שמאפיינים שושלת שלמה של מלכים",
			"כמה סוסים במרכבה",
			"אני סמלה של אחת מערי סיציליה ובאסטרולוגיה אני גם סמל של אחד המזלות",
			"כדי לרכוש אותי, אין צורך בדרכמות רבות. למעשה, מבין בעלי החיים, אני הזול ביותר.",
			"שמי בלועזית חבוי בשמה של העיר אשר הטביעה את דמותי על מטבעותיה",
			"אני הגדול שביונקי הים ובמקרא מסופר שבלעתי בן אדם, מה שמי",
			"בצד אחד של המטבע מופיע סוס מושך מרכבה ובצדו השני, מוטבעת דמותי השומרת על חומות העיר העתיקה",
			"פה אני מוטבעת על מטבע, אך בדרך כלל אני מתעופפת בין פרחים",
			"בצד אחד שלי מופיעה תפרחת השושן (המוכרת לנו היום ממטבע השקל החדש), מה מופיע בצדי השני",
			"אני בעל חיים שחי במים וביבשה ובעבר השתמשו בי לצורך שקילה"
		],
	"answers" :
		[
			"ינשוף, אוח, כוס חרבות, לילית",
			"אריה , ליש, כפיר, שחל, לביא",
			"נשר",
			"שור, פר, בן בקר, פרדיננד",
			"אריה , ליש, כפיר, שחל, לביא ",
			"פיל",
			"עיט, נשר",
			"4, ארבעה, ארבע",
			"סרטן",
			"חמור",
			"לאון, leon, אריה, ליש, שחל, כפיר, גור, לאוניטיום, לאוניטי",
			"לויתן",
			"אריה , ליש, כפיר, שחל, לביא",
			"דבורה",
			"עיט",
			"צפרדע"
		],
	"feedbackCorrect" : 
		[
			'העיר אתונה נקראת על שם אלת החוכמה והמלחמה – אתנה, אשר הינשוף היה בעל החיים המסמל אותה. מאוחר יותר הפך הינשוף לסמל המדע. הינשוף מוכר בתור סימן לעתידות, אך גם למעשי כשפים ובשורות רעות שמו של הינשוף נגזר מהמילה "נשף", שפירושה "לילה", ואולי גם בגלל קולות הנשיפה שהינשוף משמיע. במקרא, הינשוף נזכר כאחד מהעופות הטמאים (בספר ויקרא), וכעוף חרבות (בספר ישעיה', 
			
			"מקורה של דמות האריה שעל המטבע, בחותם מתקופת המלוכה. מלך החיות המופיע על מטבע זה הוא היחיד מבין מטבעות מדינת ישראל שלא היה בשימוש על מטבעות היהודים בעבר.", 
			
			"מכוון שהצלחת לזהות חשוב שתדע שעל המטבעות המוסלמים מופיעים בעיקר פסוקי קוראן ומעט מאוד דימויים. הנשר, שמופיע על מטבע בני שבט הארתק, מגיע מהתרבות הביזאנטית שהשפיעה על התרבות של בני שבט זה",
			
			"'וואלה נכון! בעת העתיקה, כאשר הרומאים כבשו ערים או הקימו חדשות, הם נהגו לסמן את גבולות העיר באמצעות חריש שבוצע על ידי שני שוורים.",
			
			"אתה משכיל ורחב אופקים וצודק מאיפעם. אלכסנדר מוקדון הפיץ את התרבות ההלניסטית במסגרת כיבושיו, שהגיעו עד הודו. התרבות ההלניסטית התקיימה ללא מפריע כאלף שנה, עד לעלייתה של האימפריה המוסלמית",
			
			"אם כבר צדקת אז דע לך הפילים היו חלק מצבא אנטיוכוס שנלחם בחשמונאים. הם הגיעו לצבא היווני לאחר הכיבושים של אלכסנדר מוקדון בהודו", 
			
			"לחכם שכמוך יהיה משמח לדעת על כל המטבעות של המלכים לבית תלמי מופיעה אותה הטבעה. בצד אחד דיוקנו של המלך תלמי הראשון ובצד השני - נשר. הנשר סימל את מלכות בית תלמי במשך קרוב ל 300 שנה", 
			
			"כמה שאתה צודק- ארבעת הסוסים הנושאים מרכבה מסמלים שני דברים במטבעות יון: לעיתים ארבעת הסוסים מסמלים את תחרויות הספורט שהתקיימו בהיפודרום, האצטדיון היווני ולעיתים מסמלים את מרכבת המלך. ניתן להבחין בין הסימולים השונים על פי הימצאותה של ניקה – אלת הניצחון המרחפת מעל הפרשים. כשהיא מופיעה, אנו יודעים שמדובר במרכבתו של המלך שניצח במלחמה.",
			
			"צודק כתמיד! בימי קדם, כל עיר הטביעה על המטבע שלה את הדבר שהכי אפיין את העיר. הסרטן כנאה היה סמל של אחת מערי החוף.", 
			
			"המידע שיש לנו על ערכם הכלכלי של בעלי חיים מגיע מתעודות שהשתמרו וכן מכתבי הפילוסופים של התקופה, אשר עסקו רבות באמצעי המסחר ובקוד האתי של כלכלת יון.", 
			
			"הגעת בהצלח ללאוניטיום, ליאוניטי, שמה של העיר בסיציליה שהאריה הוא סמלה, נקראת על שם האריה – מלך החיות. ליאו בלעז פירושו אריה, ומשמעות שמה של העיר ליאוניטי הוא העיר של האריה",
			
			'חד עין שכמוך, הלוויתן הוא שמה של מפלצת ים אגדתית מהתנ"ך, המתוארת כתנין עצום או נחש ים אימתני. במרוצת השנים הנצרות אמצה את דמותו של הלוויתן כסמל של רוע וכוח שטני שיושמד על ידי אלוהים ביום הדין.', 
			
			"הצלחת, סמל האריה הופיע פעמים רבות בימי קדם כשומר העיר. האריה מסמל אומץ וגבורה ולכן תפקד כשומר מגן שלא מאפשר לזרים להתקרב אל חומות העיר. ערים שנשמרו על ידי אריות היו ערים חזקות ושמורות.", 
			
			'כנראה את המתקרב למעמדו של שלמה החכם באדם, בתקופת יוון כל עיר הטביעה על מטבעותיה את הדימוי שייחד אותה. העיר שסמלה היה "דבורה", הייתה ידועה, ככל הנראה, בגידול דבורים וייצור דבש.',
			
			"בתקופה הפרסית הוטבע לראשונה הסמל הידוע המופיע היום על מטבעות השקל. זהו תפרחת השושן. העיט, שהיה והנו כיום, סמל לשלטון, מופיע על הצד השני של מטבע זה. זהו מטבע לא שגרתי, שכן זהו המטבע היהודי היחידי מימי קדם, שמציג דמות של בעל חיים.",
			
			"בתקופות קדומות המצרים והיונים הרגישו צורך להביע את היכולת האמנותית שלהם גם בתחומי היום יום ולכן את המשקולות עיצבו בצורה של בעלי חיים."
		], 
	"hitImageAfter" : 
		[
			"https://lh3.googleusercontent.com/2GIMo8V_ry-LYzLiw848iaAW6Gzb854X9uPDH7m95lep=w370-h375-p-no",
			"https://lh3.googleusercontent.com/y5KES5g-nuLR0wdeY9u-rxLm_DCk2CO1M3QR9RdDrcuq=w210-h207-p-no",
			"https://lh3.googleusercontent.com/S1gJp-U8Rk_162hdWkgYP6KCNU61zxM1iouuP2yGGAb6=s196-p-no",
			"https://lh6.googleusercontent.com/QW4O7oJcMbUlYY5PNsspkAZb_1wv0Brv2caDt2XPqw5C=w207-h196-p-no",
			"https://lh6.googleusercontent.com/2YRgspiv5ZbQSwxDjfbrMtg0gt6QGhd4566CI2P6y6Go=w194-h196-p-no",
			"https://lh5.googleusercontent.com/NUQyRztJk72Oth1IfVHGzRGdBERqoduoB_WpecHPQA4r=w213-h209-p-no",
			"https://lh5.googleusercontent.com/Tg8Vr_uVmnUDSjpDHakCRrxDdbJPJdaFYneH2lUxrHrF=w225-h209-p-no",
			"https://lh6.googleusercontent.com/8x_h3lfR5vRT9qAVTRiiChln9a9OPPRfsUeYbpIDH7H3=w202-h196-p-no",
			"https://lh4.googleusercontent.com/YeVO3NOM-J9tj0Xw64SykxpR3b104Ah73D3PpoHmMz8a=w202-h196-p-no",
			"https://lh4.googleusercontent.com/_nDBr7oVj1f8oj9uhwndsPgYjVaw3KCy9YYiFCFW8u6V=w250-h209-p-no",
			"https://lh5.googleusercontent.com/ApZEsjkn4_FkmjeDoNwn496DZVle8ygwocmYaYEFclUd=w200-h196-p-no",
			"https://lh3.googleusercontent.com/-XoCVGqpqEK-aNlSyLS9lSGnz4bEFNyPOTEoGPdvA5LH=w219-h207-p-no",
			"https://lh6.googleusercontent.com/Ir1Jw7H7nKs4x-QNQ6JXNjdvnbK0B7RVuog1coHImsXV=w407-h209-p-no",
			"https://lh6.googleusercontent.com/jGP5uLaA7zkUzUrXi5VNygoP6SRtjflFURpcM5EmjuBy=w219-h209-p-no",
			"https://lh6.googleusercontent.com/ablCnl22cDXB0WGcLZO0IXAPRXHQAosVaGNueKRDrdOh=w202-h209-p-no",
			"https://lh4.googleusercontent.com/lu1XZaGrZc9fnswcovv26NmGkkTy3xSX8ybHP4KNGUzM=w282-h196-p-no"
		]
}

var currentPlayer,ajaxUpdate;

$(document).on('pageinit', '#page1', function (event, data) {	
	
});

$(document).ready(function() {	
	
	$('#squareContainer').on('click','a',function (){	
		var id = $(this).attr('data-idsquare');		
		
		if($(this).attr('data-answered') == 'false') {
			$('#questionPopup .question-popup').text(appData.questions[id]);
			$('#questionPopup .container-question-popup a').attr('data-idsquare',id);
			$('#questionPopup').popup('open');
		}
		else
		{
			$('#questionPopup .container-question-popup').hide();
			$('#questionPopup .feedback').show();
			$('#questionPopup .feedback').text(appData.feedbackCorrect[id]);
			$('#questionPopup').popup('open');
		}
	});	
	
	$('#questionPopup .container-question-popup a').on('click',function(){
		var id = $(this).attr('data-idsquare');
		var userAnswer = $('#questionPopup .container-question-popup').find('input').val();
		var answers = _.invoke(appData.answers[id].split(','), 'trim');
	
		if(_.contains(answers,userAnswer.trim())){
			UpdateUserProgress (id);			
		}
		else
		{		
			$('#questionPopup .container-question-popup').hide();
			var errorHtml = $('<img src="' + appData.hitImageAfter[id] +'" height="200" width="300"/>' + 
						        '<br />' + 
						     '<b>נסה שוב, הנה רמז</b>');
						
			$('#questionPopup .feedback').append(errorHtml);
			$('#questionPopup .feedback').show();
			$('#questionPopup').resize();
		}		
	});
	
	$('#questionPopup').on({
		popupafterclose: function(event, ui) {
			$('#questionPopup .container-question-popup').show();
			$('#questionPopup .feedback').empty();
			$('#questionPopup .feedback').hide();
			$('#questionPopup .container-question-popup').find('input').val('');
		}
	}); 
	
	
	if (GetParamterUrl('id') != '')
	{
		GetProgressPlayer(GetParamterUrl('id'));
	}
	else
	{
		_.each(appData.imageBefore,function(element, index){ 
			var square = '<a data-role="button" href="#" data-corners="false" ' + 
							'data-inline="true" data-idsquare="' + index +'" data-answered="false">' + 
							'<img src="' + element +'" height="80" width="60"/>' + 
						  '</a>';
			$('#squareContainer').append($(square)); 
		});
		$('.ui-page').trigger('create');	
	}
	
	
});

function UpdateUserProgress (id){
	
	var arrayTemp = currentPlayer.playerProgress.split('');
	arrayTemp[id] = "1";
	var stringProgress = arrayTemp.join('');
	
	if(ajaxUpdate){
		ajaxUpdate.abort();
	}
	
	var player = new PlayerService();
	var promise = player.UpdateUserProgress({ "playerId":GetParamterUrl('id'),"playerProgress":stringProgress});
	ajaxUpdate = promise; 
	$.mobile.showPageLoadingMsg();
	
	promise.done(function(data){	
		
		if (data.status = "ok") {
			
			$('#questionPopup .container-question-popup').hide();
			$('#questionPopup .feedback').show();
			$('#questionPopup .feedback').text(appData.feedbackCorrect[id]);
			//force popup to resize
			$('#questionPopup').resize();
			
			var squareClicked = $('#squareContainer a')[id];
			$(squareClicked).attr('data-answered','true');
			$(squareClicked).find('img').attr('src',appData.hitImageAfter[id]);
		} 
		
		$.mobile.hidePageLoadingMsg();
		
	}).error(function(er){ console.log(er); $.mobile.hidePageLoadingMsg(); });
	
}



function GetProgressPlayer (id) {
	
	var player = new PlayerService();
	var promise = player.getUserProgress({ "playerId":id});
	promise.done(function(data){	
		
		if (data.status = "ok") {
			CreateSquare (data);
			currentPlayer = data;
		}
		
	}).error(function(er){ console.log(er);});
}

function CreateSquare(data) {
	//data.playerProgress.charAt(5)
	_.each(appData.imageBefore,function(element, index,list){ 
	
		var square = '';
		
		if (data.playerProgress.charAt(index) == "1")
		{
			
			square = '<a data-role="button" href="#" data-corners="false" ' + 
						'data-inline="true" data-idsquare="' + index +'" data-answered="true">' + 
						'<img src="' + appData.hitImageAfter[index] +'" height="80" width="60"/>' + 
					  '</a>';
			
		}
		else
		{
			square = '<a data-role="button" href="#" data-corners="false" ' + 
							'data-inline="true" data-idsquare="' + index +'" data-answered="false">' + 
							'<img src="' + element +'" height="80" width="60"/>' + 
						  '</a>';
		}		
		
		$('#squareContainer').append($(square)); 		
	});
		
	$('.ui-page').trigger('create');
}

function GetParamterUrl (name) {
	
	name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
	var regexS = "[\\?&]" + name + "=([^&#]*)";
	var regex = new RegExp(regexS);
	var results = regex.exec(window.location.href);
	if(results == null)
	return "";
	else
	return decodeURIComponent(results[1].replace(/\+/g, " "));
	
}